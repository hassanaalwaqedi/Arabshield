rules_version = '2';

/**
 * ArabShield Firestore Security Rules
 * Phase 3A.1: Security Corrections & Hardening
 * 
 * Key principles:
 * - All reads/writes require authentication + email verification
 * - Users can ONLY access their own data (ownership enforced)
 * - Role escalation explicitly blocked
 * - Invoice deletion HARD BLOCKED (financial records)
 * - Audit logs: server-write only, admin-read only
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // Helper Functions
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }
    
    function isVerifiedUser() {
      // DEVELOPMENT: Allowing non-verified users for testing
      // TODO: In production, uncomment the email verification check
      return isAuthenticated();
      // return isAuthenticated() && isEmailVerified();
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get user's role from Firestore
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if current user has 'owner' role
    function isOwnerRole() {
      return isAuthenticated() && getUserRole() == 'owner';
    }
    
    // Check if current user has 'admin' role
    function isAdminRole() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Check if current user has admin privileges (owner OR admin role)
    function hasAdminPrivileges() {
      return isAuthenticated() && (getUserRole() == 'owner' || getUserRole() == 'admin');
    }
    
    // Helper to check if user is member or owner role
    function isMemberOrOwner() {
      let role = getUserRole();
      return isAuthenticated() && (role == 'member' || role == 'owner' || role == 'admin');
    }
    
    // Helper to check if user owns a specific project
    function isProjectOwner(projectId) {
      return isVerifiedUser() && 
        get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
    }
    
    // ==========================================
    // Users Collection
    // FIX #1: Users can delete their OWN profile
    // FIX #5: Role field explicitly protected
    // ==========================================
    match /users/{userId} {
      // Users can read their own profile
      // Owner role can read any profile (for admin panel)
      allow read: if isOwner(userId) || isOwnerRole();
      
      // Users can create their own profile on registration
      // FIX #5: Role MUST be 'client' on creation - no escalation
      allow create: if isOwner(userId) && 
        request.resource.data.keys().hasAll(['uid', 'email', 'name', 'role', 'createdAt']) &&
        request.resource.data.uid == userId &&
        request.resource.data.role == 'client';  // ENFORCED: New users are always 'client'
      
      // FIX #5: Users can update their own profile but CANNOT change role or uid
      // Role changes require owner role (handled separately)
      allow update: if isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']);
      
      // FIX #5: Owner role can update ANY user including role changes
      // This allows admins to promote/demote users
      allow update: if isOwnerRole() && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid']);
      
      // FIX #1: Users can delete their OWN account
      // FIX #1: Owner role can delete ANY user account
      allow delete: if isOwner(userId) || isOwnerRole();
    }
    
    // ==========================================
    // Projects - Owned by user
    // ==========================================
    match /projects/{projectId} {
      // User can read their own projects
      // Owner role can read all projects (admin)
      // DEVELOPMENT: Allow authenticated users to read for dashboard stats
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid || 
        isOwnerRole()
      );
      
      // Users can create projects with themselves as owner
      allow create: if isVerifiedUser() && 
        request.resource.data.ownerId == request.auth.uid;
      
      // Owners can update their projects (cannot transfer ownership)
      allow update: if isVerifiedUser() && 
        resource.data.ownerId == request.auth.uid &&
        request.resource.data.ownerId == request.auth.uid;
      
      // Owners can delete their projects
      allow delete: if isVerifiedUser() && 
        resource.data.ownerId == request.auth.uid;
    }
    
    // ==========================================
    // Tasks - Project-based access
    // ==========================================
    match /tasks/{taskId} {
      // Read access:
      // - Admin can read all tasks
      // - Assigned user can read their tasks
      // - Project owner can read their project's tasks
      allow read: if isAuthenticated() && (
        hasAdminPrivileges() ||
        resource.data.assignedTo == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      
      // Task creation requires:
      // - User must be authenticated
      // - projectId field must exist
      allow create: if isVerifiedUser() && 
        request.resource.data.keys().hasAll(['projectId', 'title']) &&
        request.resource.data.projectId != null &&
        request.resource.data.projectId != '';
      
      // Task update rules:
      // - Admin can update anything
      // - Assigned user can update
      // - Owner can update
      allow update: if isAuthenticated() && (
        hasAdminPrivileges() ||
        resource.data.assignedTo == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      
      // Task deletion:
      // - Admin can delete
      // - Owner can delete
      allow delete: if isAuthenticated() && (
        hasAdminPrivileges() ||
        resource.data.ownerId == request.auth.uid
      );
    }
    
    // ==========================================
    // Invoices - Financial Records
    // FIX #3: HARD BLOCK deletion (even for admin)
    // ==========================================
    match /invoices/{invoiceId} {
      // Users can read their own invoices
      // Owner role can read all invoices
      // DEVELOPMENT: Allow authenticated users to read for dashboard stats
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        isOwnerRole()
      );
      
      // FIX #3: Only owner role can create invoices
      allow create: if isOwnerRole();
      
      // FIX #3: Only owner role can update invoices
      allow update: if isOwnerRole();
      
      // FIX #3: HARD BLOCK - NO ONE can delete invoices
      // Invoices must be retained for financial/legal compliance
      // Use soft-delete (status: 'cancelled') instead
      allow delete: if false;  // PERMANENTLY BLOCKED
    }
    
    // ==========================================
    // Support Tickets - Authored by user
    // ==========================================
    match /tickets/{ticketId} {
      // Users can read their own tickets
      // Owner role can read all tickets
      // DEVELOPMENT: Allow authenticated users to read for dashboard stats
      allow read: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid || 
        isOwnerRole()
      );
      
      // Users can create tickets with themselves as author
      allow create: if isVerifiedUser() && 
        request.resource.data.authorId == request.auth.uid;
      
      // Users can update their own tickets
      // Owner role can update any ticket
      allow update: if (isVerifiedUser() && resource.data.authorId == request.auth.uid) 
        || isOwnerRole();
      
      // Only owner role can delete tickets
      allow delete: if isOwnerRole();
    }
    
    // ==========================================
    // Activities - System generated
    // ==========================================
    match /activities/{activityId} {
      // Users can read their own activities
      // DEVELOPMENT: Allow authenticated users to read for dashboard
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Only server/admin creates activities
      allow create: if isOwnerRole();
      allow update, delete: if isOwnerRole();
    }
    
    // ==========================================
    // Documents (File metadata)
    // ==========================================
    match /documents/{documentId} {
      // Users can read documents they uploaded
      // Project owner can read project documents
      allow read: if isVerifiedUser() && (
        resource.data.uploadedBy == request.auth.uid ||
        isProjectOwner(resource.data.projectId)
      );
      
      // Users can upload documents
      allow create: if isVerifiedUser() && 
        request.resource.data.uploadedBy == request.auth.uid;
      
      // Users can delete their own documents
      allow delete: if isVerifiedUser() && 
        resource.data.uploadedBy == request.auth.uid;
      
      // No document updates (immutable)
      allow update: if false;
    }
    
    // ==========================================
    // Ratings - Public read, own write
    // ==========================================
    match /ratings/{ratingId} {
      // Verified users can read all ratings
      allow read: if isVerifiedUser();
      
      // Users can create ratings with their ID
      allow create: if isVerifiedUser() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own ratings
      allow update: if isVerifiedUser() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own ratings
      allow delete: if isVerifiedUser() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ==========================================
    // Messages (Project Chat)
    // ==========================================
    match /messages/{projectId}/messages/{messageId} {
      // Verified users can read messages
      allow read: if isVerifiedUser();
      
      // Users can create messages with their ID
      allow create: if isVerifiedUser() && 
        request.resource.data.senderId == request.auth.uid;
      
      // Messages are immutable (no edit/delete)
      allow update, delete: if false;
    }
    
    // ==========================================
    // Statistics - Shared (read-only for users)
    // ==========================================
    match /statistics/{docId} {
      // Verified users can read statistics
      allow read: if isVerifiedUser();
      
      // Only owner role can write statistics
      allow write: if isOwnerRole();
    }
    
    // ==========================================
    // Audit Logs - FIX #4
    // Server-write only, admin-read only
    // ==========================================
    match /audit_logs/{logId} {
      // FIX #4: Only owner role can read audit logs
      allow read: if isOwnerRole();
      
      // FIX #4: DENY all client-side writes
      // Audit logs must be created server-side only (Cloud Functions)
      allow create: if false;  // Server-only via Firebase Admin SDK
      
      // FIX #4: Audit logs are immutable
      allow update, delete: if false;
    }
    
    // ==========================================
    // System Settings - Admin only
    // ==========================================
    match /system/{docId} {
      // Only admin/owner can read system settings
      allow read: if hasAdminPrivileges();
      
      // Only admin/owner can write system settings
      allow write: if hasAdminPrivileges();
    }
    
    // ==========================================
    // Catch-all: Deny everything else
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
